{% extends "::base.html.twig" %}
{% block stylesheets %}
<link href="http://d2dm6eqgiezevm.cloudfront.net/css/bootstrap.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://d2dm6eqgiezevm.cloudfront.net/css/bootstrap-responsive.css" media="screen" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="http://d2dm6eqgiezevm.cloudfront.net/css/bootstrap.datepicker.css">

<link rel="stylesheet" href="http://d2dm6eqgiezevm.cloudfront.net/css/smooth/jquery-ui-1.8.16.custom.css" >
<link rel="stylesheet" href="{{asset('css/style.css')}}" type="text/css" >

<!-- Scripts -->
{% endblock %}
        
{% block content %}
<div class="container-fluid">
    <div class="content">
        <div class="row-fluid">
            <div class="span12">
                <div class="box">
                    <div class="box-head tabs">
                        <h3>Registro Encuentro</h3>
                        <ul class="nav nav-tabs">
                            <li class='active'>
                                <a href="#basic" data-toggle='tab'>Información Básica</a>
                            </li>
                        </ul>
                    </div>
                    <div class="box-content box-nomargin">
                        <form action="#" class="form-horizontal" id="form_encuentro" name="form_encuentro" method="POST" style="padding-top:15px;">
                            <div class="tab-content">
                                <div class="tab-pane active" id="basic">
                                    <fieldset>
                                        <div class="row-fluid">
                                            <div class="span3">
                                                <div class="control-group">
                                                    <label for="f_inicio" class="control-label">Fecha Inicio</label>
                                                    <div class="controls">
                                                        <input type="text" class="input-small datepick" id="f_inicio" name="f_inicio" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="span3">
                                                <div class="control-group">
                                                    <label for="h_inicio" class="control-label">Hora Inicio</label>
                                                    <div class="controls">
                                                        <input type="time" class="input-small" id="h_inicio" name="h_inicio" required default="11:00:00">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row-fluid">
                                            <div class="span3">
                                                <div class="control-group">
                                                    <label for="f_fin" class="control-label">Fecha fin</label>
                                                    <div class="controls">
                                                        <input type="text" class="input-small datepick" id="f_fin" name="f_fin" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="span3">
                                                <div class="control-group">
                                                    <label for="h_fin" class="control-label">Hora fin</label>
                                                    <div class="controls">
                                                        <input type="time" class="input-small" id="h_fin" name="h_fin" required default="11:00:00">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row-fluid">
                                            <div class="control-group">
                                                <label for="lugar" class="control-label">Lugar</label>
                                                <div class="controls">
                                                    <select id="red_lista" name="red_lista"></select>
                                                </div>
                                            </div>
                                            <div class="control-group">
                                                <label class="control-label">Persona</label>
                                                <input id="persona_id" name="persona_id" type="hidden">
                                                <div class="controls">
                                                    <textarea id="descripcion" name="descripcion" class="input-xxlarge" required></textarea>
                                                </div>
                                            </div>
                                            <div class="control-group">
                                                <label for="red_lista" class="control-label">Red</label>
                                                <div class="controls">
                                                    <select id="red_lista" name="red_lista">
                                                        
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="control-group">
                                                <label class="control-label"> Persona</label>
                                                <input id="persona_id" name="persona_id" type="hidden">

                                                <div class="controls">
                                                    <input id="persona" name="persona" class="input-large" type="text" >
                                                    <input type="button" class="btn btn-small" value="+" id="add_persona" name="add_persona">
                                                </div>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>

                            </div>
                            <div class="form-actions">
                                <input type="submit" class='btn btn-primary' value="Añadir" id="btnGuardarCelula" name="btnGuardarCelula">
                                <input type="reset" class='btn btn-danger' value="Cancelar"></div>
                        </form>

                        <div >
                            <table class='table table-condensed table-striped table-hover table-bordered pull-left' id='table_personas'>
                                <thead>
                                    <tr>
                                        <th style='width:16%'>N°</th>
                                        <th style='width:43%'>Persona</th>
                                        <th style='width:17%'>Red</th>
                                        <th style='width:23%'>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class='row-fluid'>
            <div class='span12'>
                <div class='box'>
                    <div class='box-head'>
                        <h3>Encuentros realizados</h3>
                    </div>
                    <div class='box-content box-nomargin'>
                        <table id="tabla_encuentro" class='table table-striped table-bordered'>
                            <thead>
                                <tr>
                                    <th>F. Inicio</th>
                                    <th>F. Fin</th>
                                    <th>Lugar</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}      

{%block javascript %}
<script type="text/javascript" src="http://d2dm6eqgiezevm.cloudfront.net/js/jquery.js"></script>
<script type="text/javascript" src="http://d2dm6eqgiezevm.cloudfront.net/js/bootstrap-typeahead.js"></script>
<script type="text/javascript" src="http://d2dm6eqgiezevm.cloudfront.net/js/bootstrap-collapse.js"></script>
<script type="text/javascript" src="http://d2dm6eqgiezevm.cloudfront.net/js/bootstrap-button.js"></script>
<script type="text/javascript" src="http://d2dm6eqgiezevm.cloudfront.net/js/bootstrap-tooltip.js"></script>
<script type="text/javascript" src="http://d2dm6eqgiezevm.cloudfront.net/js/bootstrap-tab.js"></script>
<script type="text/javascript" src="http://d2dm6eqgiezevm.cloudfront.net/js/bootstrap.js"></script>
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/custom.js"></script>
<!--[if lt IE 9]>
<script type="text/javascript" src="http://d2dm6eqgiezevm.cloudfront.net/js/html5.js"></script>
<![endif]-->
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/util/functiongen.js"></script>
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/jquery/jquery.ui.core.min.js"></script>
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/jquery/jquery.ui.widget.min.js"></script>
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/jquery/jquery.ui.position.min.js"></script>
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/jquery/jquery.ui.autocomplete.min.js"></script>
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/bootstrap.datepicker.js"></script>
<script src="{{asset('js/util/functiongen.js')}}"></script>
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/jquery.dataTables.js"></script>
<script src="{{asset('js/jquery.dataTables.bootstrap.js')}}"></script>
<script src="http://d2dm6eqgiezevm.cloudfront.net/js/util/datatable_plugins.js"></script>

<script type="text/javascript">
    var redes = null;    
    var urlES = "https://s3.amazonaws.com/acfinal/dt_ES.txt";
    var SourceTEncuentros = "{{path('servicio_encuentro_all')}}";
    var DatosEnviar = null;
    var personas = null;
    var encuentrosTable = null;
    var RowCBTEncuentro = null; // RowCBTEncuentro = Row CallBack Table Encuentro
    var columnas_encuentros = [
        {"mDataProp": "inicio"},
        {"mDataProp": "fin"},
        {"mDataProp": "lugar"},
        {"mDataProp": "acciones"}];

    PrepararDatos = function()
    {
        DatosEnviar = {
            "formulario": $("#form_membresia").serializeObject()
        };
    };

    SuccessFunction = function(data)
    {
        console.log(data);
        if(data.responseCode===200 )
        {
            $("#form_celula").reset();
            cargarSelect(redes, "red_lista", "int_red_id", "id");
            alert('Registro Completado');
            $("#persona_id").val(-1);                        
        }
        else 
        {
            if(data.responseCode===400)
            {
                alert('Error bad request');
            }
            else
            {                      
                if(data.responseCode===500)
                {
                    alert('Error bad request');
                }
                else 
                    alert("An unexpeded error occured.");
            }
        }        
    };

    persona_cambio_red = function()
    {
        red = $("#red_lista").val();
        
        if(red != '-1')
        {
            url = '{{path( 'services_sinbautizo_autocomplete_red',{'red':'nom'})}}';
            url = url.replace('nom',red);
                            
            personas = getAjaxObject(url);                     
            $("#persona").autocomplete({
                source: personas,
                select: function(event, ui) 
                {
                    $("#persona_id").val(ui.item.id);
                    $("#persona").val(ui.item.label);
                    return false;
                }
            }); 
        }
       
    };
    
    $(document).ready(function()
    {
        redes = getAjaxObject('{{path('services_red')}}');                          
        cargarSelect(redes, "red_lista", "int_red_id", "id");

        personasTabla = $('#table_personas').dataTable({
            "aoColumns":[
                {"mDataProp": "id"}, 
                {"mDataProp": "persona"},
                {"mDataProp": "red"},
                {"mDataProp": "btn_elim"}],
            "bPaginate": false,
            "sDom": "<r>t<'row-fluid'>",
            "fnCreatedRow": function(nRow, aData, iDisplayIndex)
            {
                $(nRow).find('.delete-row').click(function(event)
                {
                    event.preventDefault();
                    var index;
                    index = $(personasTabla.fnGetData()).getIndexObj(aData, 'id');
                    personasTabla.fnDeleteRow(index);
                });
            }
        });

        RowCBTEncuentro = function(nRow, aData, iDisplayIndex)
        {
            $(nRow).find('.edit_row').click(function(event)
            {
                event.preventDefault();
                $("#modalEditarEncuentro").modal("show");
            });
        };

        $('#add_persona').click(function(event)
        {
            var num, leccion;
            event.preventDefault();
            if ($("#persona").val().length > 0 && $("#persona_id").val()!= '-1')
            {

                leccion = {
                    "id": $("#persona_id").val(),
                    "persona": $("#persona").val(),
                    "red": $("#red_lista option:selected").text(),
                    "btn_elim": getActionButtons("001")
                };

                personasTabla.fnAddData(leccion);
                $("#persona").val("");
                $("#persona_id").val(-1);
                return false;
            }
        });

        $("#form_membresia").submit(function(event)
        {
            event.preventDefault();
            PrepararDatos();
            if($("#persona_id").val() != '-1')
                return enviar('{{path('membresia_save')}}', DatosEnviar, SuccessFunction, null);
            else
                alert('Seleccione una persona');
        });
        
        $("#red_lista").change(persona_cambio_red);
        encuentrosTable = createDataTable("tabla_encuentro",SourceTEncuentros,columnas_encuentros,null,RowCBTEncuentro);
    
    });

</script>
{%endblock %}{# empty Twig template #}
